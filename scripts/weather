#!/usr/bin/perl -w

$PORT = shift;
$SERVER = shift;
$TARGET = shift;
$OPTION = shift;

@stations = `dcop KWeatherService WeatherService listStations`;

if( ! @stations ) {
  exec ("dcop $PORT Konversation say $SERVER \"$TARGET\" \"KWeather is not installed or not running!\" ");
} 

if( $OPTION && $stations[$OPTION-1] ) {
  @stations = $stations[$OPTION-1];
}

foreach $station (@stations) {

  $city = `dcop KWeatherService WeatherService stationName $station`;
  $temperature = `dcop KWeatherService WeatherService temperature $station`;
  $pressure = `dcop KWeatherService WeatherService pressure $station`; 
  $wind = `dcop KWeatherService WeatherService wind $station`;
  $detail = `dcop KWeatherService WeatherService weather $station`;
  $detail2 = `dcop KWeatherService WeatherService cover $station`;

  # Fix details
  
  $i = 0;
  chomp $detail;
  
  foreach $det (split(/\n/,$detail)) {
    chomp $det;
    if( $i==0 ) {
      $details = $det;
      $i = 1;
    }
    else {
      $details = $details.", ".$det;
    }
  }

  # Fix detail2

  $i = 0;
  chomp $detail2;
  
  foreach $det (split(/\n/,$detail2)) {
    chomp $det;
    if( $i==0 ) {
      $details2 = $det;
      $i = 1;
    }
    else {
      $details2 = $details2.", ".$det;
    }
  }
  
  
  $pressure =~ s/\"/\\\"/g; # Escape double quote

  chomp $city;
  chomp $temperature;
  chomp $pressure;
  chomp $wind;

  if ( $details2 =~ /(\S)+/ ) {
      print "Inside\n";
      if( $details =~ /(\S)+/ ) {
	  $details = $details.", ".$details2;
      }
      else {
	  $details = $details2;
      }
  }
      


  if( $details =~ /(\S)+/ ) {
  $MESSAGE = "Current Weather for %B$city%B : %B$details%B, Temperature: %B$temperature%B, Pressure: %B$pressure%B, Wind: %B$wind%B";
  }
  else {
  $MESSAGE = "Current Weather for %B$city%B : Temperature: %B$temperature%B, Pressure: %B$pressure%B, Wind: %B$wind%B";
  }
  
  system ("dcop $PORT Konversation say $SERVER \"$TARGET\" \"$MESSAGE\" ");
  
}
